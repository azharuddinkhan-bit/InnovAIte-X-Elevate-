<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dynamic Hacker Terminal Puzzle</title>
<style>
body { 
    margin:0; 
    background:black; 
    color:#FFB700; /* text color changed */ 
    font-family:"Courier New", monospace; 
    overflow:hidden; 
    display:flex; 
}
#keylogBox { 
    width:260px; 
    border-right:1px solid #1B5287; /* outline color changed */ 
    padding:10px; 
    height:100vh; 
    overflow-y:auto; 
    background:rgba(0,0,0,0.4);
    color:#FFB700; /* text color changed */
}
#terminal { 
    padding:20px; 
    flex-grow:1; 
    height:100vh; 
    overflow-y:auto;
    color:#FFB700; /* text color changed */
}
input, button { 
    background:black; 
    color:#FFB700; /* text color changed */
    border:1px solid #1B5287; /* outline color changed */
    padding:6px; 
    font-family:monospace;
}
#hackOutput { 
    display:none; 
    margin-top:20px; 
    border:1px solid #1B5287; /* outline color changed */
    padding:10px; 
    height:350px; 
    overflow-y:auto; 
    white-space:pre-line; 
    background:rgba(0,0,0,0.6);
    color:#FFB700; /* text color changed */
}
#crt { 
    position:fixed; 
    top:0; 
    left:0; 
    width:100%; 
    height:100%; 
    pointer-events:none; 
    z-index:9999;
    background:repeating-linear-gradient(to bottom, rgba(27,82,135,0.08), rgba(27,82,135,0.08) 3px, rgba(27,82,135,0.02) 4px); /* CRT scanline color changed */
    animation: crtPulse 0.25s infinite;
}
@keyframes crtPulse {0%{opacity:0.18}50%{opacity:0.23}100%{opacity:0.18}}
@keyframes shake {0%{transform:translateX(0px)}25%{transform:translateX(-6px)}50%{transform:translateX(6px)}75%{transform:translateX(-4px)}100%{transform:translateX(0px)}}
.errorShake { animation: shake 0.25s;}
</style>
</head>
<body>
<div id="crt"></div>
<div id="keylogBox">
<h3>Keylog Monitor</h3>
<pre id="keylog"></pre>
</div>
<div id="terminal">
<h2>TERMINAL ACCESS</h2>
<pre id="puzzleText"></pre>
<input type="text" id="puzzleInput">
<button id="submitPuzzle">SUBMIT</button>
<div id="hackOutput"></div>
</div>

<script>
//------------------ KEYLOGGER ------------------
let keylog=document.getElementById("keylog");
window.addEventListener("keydown",e=>{ 
    keylog.textContent+=`[${new Date().toLocaleTimeString()}] ${e.key}\n`; 
    keylog.scrollTop=keylog.scrollHeight;
});

//------------------ RANDOM HELPERS ------------------
function rand(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
function pick(arr){return arr[rand(0,arr.length-1)];}

//------------------ LEVEL SETUP ------------------
let level=1;
let puzzleText=document.getElementById("puzzleText");
let input=document.getElementById("puzzleInput");
let output=document.getElementById("hackOutput");

// Hidden numbers
let N1 = rand(5,15);
let N2 = rand(5,15);
let N3 = rand(5,15);
let N4 = rand(5,15);
let N5 = rand(5,15);

// Operators for randomness
let ops = ['+', '-', '*'];

// Function to generate expression string and calculate result
function generateExpression(level){
    let expr="", result;
    switch(level){
        case 1:
            let V1=rand(10,20);
            result = V1*2 + N1;
            return {expr:`LEVEL 1 — Structural Offset\n----------------------------------------\nV1*2 + N1 = ${result}\nV1=${V1}\nSolve for N1:`, answer:N1};
        case 2:
            let a2=rand(2,5);
            result = N1*a2 + N2;
            return {expr:`LEVEL 2 — Load Factor Alignment\n----------------------------------------\nN1*${a2} + N2 = ${result}\nSolve for N2:`, answer:N2};
        case 3:
            let a3=rand(2,6);
            result = (N1+N2)*a3 - N3;
            return {expr:`LEVEL 3 — Sequence Flux Stabilization\n----------------------------------------\n(N1+N2)*${a3} - N3 = ${result}\nSolve for N3:`, answer:N3};
        case 4:
            let a4=rand(1,3), b4=rand(1,3), c4=rand(1,3);
            result = N1*a4 + N2*b4 + N3*c4 + N4;
            return {expr:`LEVEL 4 — Harmonic Expansion\n----------------------------------------\n(N1*${a4} + N2*${b4} + N3*${c4}) + N4 = ${result}\nSolve for N4:`, answer:N4};
        case 5:
            let a5=rand(2,4);
            result = (N1+N2+N3)*a5 + N4 - N5;
            return {expr:`LEVEL 5 — Stabilizer Core Equation\n----------------------------------------\n((N1+N2+N3)*${a5} + N4) - N5 = ${result}\nSolve for N5:`, answer:N5};
        case 6:
            result = N1+N2+N3+N4+N5;
            return {expr:`FINAL RECONSTRUCTION\n----------------------------------------\nN1 + N2 + N3 + N4 + N5 = ?\nEnter FINAL KEY:`, answer:result};
    }
}

//------------------ SHOW LEVEL ------------------
function showLevel(){
    let data = generateExpression(level);
    puzzleText.textContent = data.expr;
    puzzleText.dataset.answer = data.answer;
}
showLevel();

//------------------ ERROR SHAKE ------------------
function shakeError(){ puzzleText.classList.add("errorShake"); setTimeout(()=>puzzleText.classList.remove("errorShake"),300);}

//------------------ USER SUBMISSION ------------------
document.getElementById("submitPuzzle").onclick=()=>{
    let val=parseInt(input.value.trim());
    input.value="";
    let correct=parseInt(puzzleText.dataset.answer)===val;
    if(correct){
        level++;
        if(level<=6){
            showLevel();
        } else {
            runLargeOutput();
        }
    } else{
        shakeError();
        keylog.textContent+=`[${new Date().toLocaleTimeString()}] System: Value mismatch detected.\n`;
        keylog.scrollTop=keylog.scrollHeight;
    }
};

//------------------ LOG OUTPUT ------------------
function runLargeOutput(){
    output.style.display="block";
    output.innerHTML="";
    let lines=[
        "[CORE ENTRY] Primary resolver engaged.",
        "Re-mapping structural deltas...",
        "Entropy bundle re-linked.",
        "Modifier-plane shows slight drift.",
        "Awaiting secondary phase stabilization...",
        "------------------------------------------------------",
        "System idle: minor directive imbalance detected.",
        "Oscillator phase misalignment persists.",
        "Ambient scan: dual-phase signals fluctuating.",
        "Subroutine: mirrored directives not fully aligned.",
        "Subsystem waiting for paired synchronization.",
        "Local actuator shows irregular pattern.",
        "Modifier channels in subtle resonance.",
        "Upper-lower directive sequence not yet harmonized.",
        "Override routine stalled: combined elevation required.",
        "System monitoring for synchronized oscillation pattern."
    ];
    let i=0;
    let interval=setInterval(()=>{
        output.innerHTML+=lines[i]+"\n";
        output.scrollTop=output.scrollHeight;
        i++;
        if(i>=lines.length) clearInterval(interval);
    },160);
}

//------------------ CTRL+SHIFT ------------------
let ctrl=false, shift=false, revealed=false;
window.addEventListener("keydown",(e)=>{
    if(e.key==="Control") ctrl=true;
    if(e.key==="Shift") shift=true;
    if(ctrl && shift && !revealed){
        revealed=true;
        showEncryptedPopup();
    }
});
window.addEventListener("keyup",(e)=>{
    if(e.key==="Control") ctrl=false;
    if(e.key==="Shift") shift=false;
});

//------------------ FINAL ENCRYPTED POPUP ------------------
function showEncryptedPopup(){
    const encrypted="I H @ ) @ ^";
    const msg=`Archival Notice:
Reference segment ${encrypted} has been recorded in the unauthorized‑access audit log.

Subsystems request immediate transition.`;

    const popup=document.createElement("div");
    popup.style.position="fixed";
    popup.style.top="50%";
    popup.style.left="50%";
    popup.style.transform="translate(-50%,-50%)";
    popup.style.background="black";
    popup.style.border="2px solid #1B5287"; // outline changed
    popup.style.padding="20px";
    popup.style.zIndex="999999";
    popup.style.color="#FFB700"; // text color changed
    popup.style.width="420px";
    popup.style.textAlign="center";
    popup.style.whiteSpace="pre-line";
    popup.innerHTML=msg;

    const btn=document.createElement("button");
    btn.innerText="OK";
    btn.style.marginTop="15px";
    btn.style.color="#FFB700"; // text color changed
    btn.style.background="black";
    btn.style.border="1px solid #1B5287"; // outline changed
    btn.style.padding="6px";
    btn.onclick=()=> { window.location.href="portal.html?err=symbol-archive"; };

    popup.appendChild(btn);
    document.body.appendChild(popup);

    // Block all escape attempts and outside clicks
    window.onkeydown=e=>e.preventDefault();
    window.onmousedown=e=>e.preventDefault();
    window.onmouseup=e=>e.preventDefault();
    window.oncontextmenu=e=>e.preventDefault();
}
</script>
</body>
</html>
